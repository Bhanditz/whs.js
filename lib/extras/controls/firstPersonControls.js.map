{"version":3,"sources":["extras/controls/firstPersonControls.js"],"names":[],"mappings":"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","file":"firstPersonControls.js","sourcesContent":["import * as THREE from 'three';\nimport {extend} from '../api';\n\nconst PI_2 = Math.PI / 2;\n\nexport function FPSControls(object, params = {}) {\n  const target = extend(params, {\n    block: document.getElementById('blocker'),\n    speed: 1,\n    ypos: 1\n  });\n\n  const controls = new ((camera, mesh, params) => {\n    const velocityFactor = 1;\n    let runVelocity = 0.25;\n\n    mesh.setAngularFactor({x: 0, y: 0, z: 0});\n\n    /* Init */\n    const scope = this,\n      player = mesh,\n      pitchObject = new THREE.Object3D();\n\n    pitchObject.add(camera.getNative());\n\n    const yawObject = new THREE.Object3D();\n\n    yawObject.position.y = params.ypos; // eyes are 2 meters above the ground\n    yawObject.add(pitchObject);\n\n    const quat = new THREE.Quaternion();\n\n    let canJump = false,\n      // Moves.\n      moveForward = false,\n      moveBackward = false,\n      moveLeft = false,\n      moveRight = false;\n\n    player.addEventListener('collision', (otherObject, v, r, contactNormal) => {\n      if (contactNormal.y < 0.5) // Use a \"good\" threshold value between 0 and 1 here!\n        canJump = true;\n    });\n\n    function onMouseMove(event) {\n      if (scope.enabled === false) return;\n\n      const movementX = event.movementX || event.mozMovementX || event.getMovementX() || 0,\n        movementY = event.movementY || event.mozMovementY || event.getMovementY() || 0;\n\n      yawObject.rotation.y -= movementX * 0.002;\n      pitchObject.rotation.x -= movementY * 0.002;\n\n      pitchObject.rotation.x = Math.max(-PI_2, Math.min(PI_2, pitchObject.rotation.x));\n    }\n\n    function onKeyDown(event) {\n      switch (event.keyCode) {\n        case 38: // up\n        case 87: // w\n          moveForward = true;\n          break;\n\n        case 37: // left\n        case 65: // a\n          moveLeft = true;\n          break;\n\n        case 40: // down\n        case 83: // s\n          moveBackward = true;\n          break;\n\n        case 39: // right\n        case 68: // d\n          moveRight = true;\n          break;\n\n        case 32: // space\n          if (canJump === true) player.applyCentralImpulse({x: 0, y: 300, z: 0});\n          canJump = false;\n          break;\n\n        case 16: // shift\n          runVelocity = 0.5;\n          break;\n\n        default:\n      }\n    }\n\n    function onKeyUp(event) {\n      switch (event.keyCode) {\n        case 38: // up\n        case 87: // w\n          moveForward = false;\n          break;\n\n        case 37: // left\n        case 65: // a\n          moveLeft = false;\n          break;\n\n        case 40: // down\n        case 83: // a\n          moveBackward = false;\n          break;\n\n        case 39: // right\n        case 68: // d\n          moveRight = false;\n          break;\n\n        case 16: // shift\n          runVelocity = 0.25;\n          break;\n\n        default:\n      }\n    }\n\n    document.body.addEventListener('mousemove', onMouseMove, false);\n    document.body.addEventListener('keydown', onKeyDown, false);\n    document.body.addEventListener('keyup', onKeyUp, false);\n\n    this.enabled = false;\n\n    this.getObject = () => {\n      return yawObject;\n    };\n\n    this.getDirection = (targetVec) => {\n      targetVec.set(0, 0, -1);\n      quat.multiplyVector3(targetVec);\n    };\n\n    // Moves the camera to the Cannon.js object position\n    // and adds velocity to the object if the run key is down.\n    const inputVelocity = new THREE.Vector3(),\n      euler = new THREE.Euler();\n\n    this.update = (delta) => {\n      const moveVec = new THREE.Vector3();\n\n      if (scope.enabled === false) return;\n\n      delta = delta || 0.5;\n      delta = Math.min(delta, 0.5);\n\n      inputVelocity.set(0, 0, 0);\n\n      const speed = velocityFactor * delta * params.speed * runVelocity;\n\n      if (moveForward) inputVelocity.z = -speed;\n      if (moveBackward) inputVelocity.z = speed;\n      if (moveLeft) inputVelocity.x = -speed;\n      if (moveRight) inputVelocity.x = speed;\n\n      // Convert velocity to world coordinates\n      euler.x = pitchObject.rotation.x;\n      euler.y = yawObject.rotation.y;\n      euler.order = 'XYZ';\n\n      quat.setFromEuler(euler);\n\n      inputVelocity.applyQuaternion(quat);\n\n      player.applyCentralImpulse({x: inputVelocity.x * 10, y: 0, z: inputVelocity.z * 10});\n      player.setAngularVelocity({x: inputVelocity.z * 10, y: 0, z: -inputVelocity.x * 10});\n      player.setAngularFactor({x: 0, y: 0, z: 0});\n\n      yawObject.position.copy(player.position);\n    };\n  })(this.getCamera(), object.getNative(), target);\n\n  this.getScene().add(this.controls.getObject());\n\n  if ('pointerLockElement' in document\n      || 'mozPointerLockElement' in document\n      || 'webkitPointerLockElement' in document) {\n    const element = document.body;\n\n    this.pointerlockchange = function () {\n      if (document.pointerLockElement === element\n        || document.mozPointerLockElement === element\n        || document.webkitPointerLockElement === element) {\n        controls.enabled = true;\n        target.block.fadeOut();\n      } else {\n        controls.enabled = false;\n        target.block.fadeIn();\n      }\n    };\n  } else console.warn('Your browser does not support the PointerLock WHS.API.');\n\n  document.addEventListener('pointerlockchange', this.pointerlockchange, false);\n  document.addEventListener('mozpointerlockchange', this.pointerlockchange, false);\n  document.addEventListener('webkitpointerlockchange', this.pointerlockchange, false);\n\n  this.pointerlockerror = function () {\n    console.warn('Pointer lock error.');\n  };\n\n  document.addEventListener('pointerlockerror', this.pointerlockerror, false);\n  document.addEventListener('mozpointerlockerror', this.pointerlockerror, false);\n  document.addEventListener('webkitpointerlockerror', this.pointerlockerror, false);\n\n  target.block.addEventListener('click', () => {\n    element.requestPointerLock = element.requestPointerLock\n      || element.mozRequestPointerLock\n      || element.webkitRequestPointerLock;\n\n    element.requestFullscreen = element.requestFullscreen\n      || element.mozRequestFullscreen\n      || element.mozRequestFullScreen\n      || element.webkitRequestFullscreen;\n\n    if (/Firefox/i.test(navigator.userAgent)) {\n      const fullscreenchange = () => {\n        if (document.fullscreenElement === element\n          || document.mozFullscreenElement === element\n          || document.mozFullScreenElement === element) {\n          document.removeEventListener('fullscreenchange', fullscreenchange);\n          document.removeEventListener('mozfullscreenchange', fullscreenchange);\n\n          element.requestPointerLock();\n        }\n      };\n\n      document.addEventListener('fullscreenchange', fullscreenchange, false);\n      document.addEventListener('mozfullscreenchange', fullscreenchange, false);\n\n      element.requestFullscreen();\n    } else element.requestPointerLock();\n  });\n\n  return controls;\n}\n"]}