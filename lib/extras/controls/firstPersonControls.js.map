{"version":3,"sources":["extras/controls/firstPersonControls.js"],"names":[],"mappings":"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","file":"firstPersonControls.js","sourcesContent":["import * as THREE from 'three';\nimport {extend} from '../api';\n\nconst PI_2 = Math.PI / 2;\n\nexport function firstPersonControls(object, params = {}) {\n  return function (world) {\n    const target = extend(params, {\n      block: document.getElementById('blocker'),\n      speed: 1,\n      ypos: 1\n    });\n\n    const controls = new ((camera, mesh, params) => {\n      const velocityFactor = 1;\n      let runVelocity = 0.25;\n\n      mesh.setAngularFactor({x: 0, y: 0, z: 0});\n\n      /* Init */\n      const scope = this,\n        player = mesh,\n        pitchObject = new THREE.Object3D();\n\n      pitchObject.add(camera.getNative());\n\n      const yawObject = new THREE.Object3D();\n\n      yawObject.position.y = params.ypos; // eyes are 2 meters above the ground\n      yawObject.add(pitchObject);\n\n      const quat = new THREE.Quaternion();\n\n      let canJump = false,\n        // Moves.\n        moveForward = false,\n        moveBackward = false,\n        moveLeft = false,\n        moveRight = false;\n\n      player.addEventListener('collision', (otherObject, v, r, contactNormal) => {\n        if (contactNormal.y < 0.5) // Use a \"good\" threshold value between 0 and 1 here!\n          canJump = true;\n      });\n\n      function onMouseMove(event) {\n        if (scope.enabled === false) return;\n\n        const movementX = event.movementX || event.mozMovementX || event.getMovementX() || 0,\n          movementY = event.movementY || event.mozMovementY || event.getMovementY() || 0;\n\n        yawObject.rotation.y -= movementX * 0.002;\n        pitchObject.rotation.x -= movementY * 0.002;\n\n        pitchObject.rotation.x = Math.max(-PI_2, Math.min(PI_2, pitchObject.rotation.x));\n      }\n\n      function onKeyDown(event) {\n        switch (event.keyCode) {\n          case 38: // up\n          case 87: // w\n            moveForward = true;\n            break;\n\n          case 37: // left\n          case 65: // a\n            moveLeft = true;\n            break;\n\n          case 40: // down\n          case 83: // s\n            moveBackward = true;\n            break;\n\n          case 39: // right\n          case 68: // d\n            moveRight = true;\n            break;\n\n          case 32: // space\n            if (canJump === true) player.applyCentralImpulse({x: 0, y: 300, z: 0});\n            canJump = false;\n            break;\n\n          case 16: // shift\n            runVelocity = 0.5;\n            break;\n\n          default:\n        }\n      }\n\n      function onKeyUp(event) {\n        switch (event.keyCode) {\n          case 38: // up\n          case 87: // w\n            moveForward = false;\n            break;\n\n          case 37: // left\n          case 65: // a\n            moveLeft = false;\n            break;\n\n          case 40: // down\n          case 83: // a\n            moveBackward = false;\n            break;\n\n          case 39: // right\n          case 68: // d\n            moveRight = false;\n            break;\n\n          case 16: // shift\n            runVelocity = 0.25;\n            break;\n\n          default:\n        }\n      }\n\n      document.body.addEventListener('mousemove', onMouseMove, false);\n      document.body.addEventListener('keydown', onKeyDown, false);\n      document.body.addEventListener('keyup', onKeyUp, false);\n\n      this.enabled = false;\n\n      this.getObject = () => {\n        return yawObject;\n      };\n\n      this.getDirection = (targetVec) => {\n        targetVec.set(0, 0, -1);\n        quat.multiplyVector3(targetVec);\n      };\n\n      // Moves the camera to the Cannon.js object position\n      // and adds velocity to the object if the run key is down.\n      const inputVelocity = new THREE.Vector3(),\n        euler = new THREE.Euler();\n\n      this.update = (delta) => {\n        const moveVec = new THREE.Vector3();\n\n        if (scope.enabled === false) return;\n\n        delta = delta || 0.5;\n        delta = Math.min(delta, 0.5);\n\n        inputVelocity.set(0, 0, 0);\n\n        const speed = velocityFactor * delta * params.speed * runVelocity;\n\n        if (moveForward) inputVelocity.z = -speed;\n        if (moveBackward) inputVelocity.z = speed;\n        if (moveLeft) inputVelocity.x = -speed;\n        if (moveRight) inputVelocity.x = speed;\n\n        // Convert velocity to world coordinates\n        euler.x = pitchObject.rotation.x;\n        euler.y = yawObject.rotation.y;\n        euler.order = 'XYZ';\n\n        quat.setFromEuler(euler);\n\n        inputVelocity.applyQuaternion(quat);\n\n        player.applyCentralImpulse({x: inputVelocity.x * 10, y: 0, z: inputVelocity.z * 10});\n        player.setAngularVelocity({x: inputVelocity.z * 10, y: 0, z: -inputVelocity.x * 10});\n        player.setAngularFactor({x: 0, y: 0, z: 0});\n\n        yawObject.position.copy(player.position);\n      };\n    })(world.getCamera(), object.getNative(), target);\n\n    world.getScene().add(world.controls.getObject());\n\n    if ('pointerLockElement' in document\n        || 'mozPointerLockElement' in document\n        || 'webkitPointerLockElement' in document) {\n      const element = document.body;\n\n      world.pointerlockchange = function () {\n        if (document.pointerLockElement === element\n          || document.mozPointerLockElement === element\n          || document.webkitPointerLockElement === element) {\n          controls.enabled = true;\n          target.block.fadeOut();\n        } else {\n          controls.enabled = false;\n          target.block.fadeIn();\n        }\n      };\n    } else console.warn('Your browser does not support the PointerLock WHS.API.');\n\n    document.addEventListener('pointerlockchange', world.pointerlockchange, false);\n    document.addEventListener('mozpointerlockchange', world.pointerlockchange, false);\n    document.addEventListener('webkitpointerlockchange', world.pointerlockchange, false);\n\n    world.pointerlockerror = function () {\n      console.warn('Pointer lock error.');\n    };\n\n    document.addEventListener('pointerlockerror', world.pointerlockerror, false);\n    document.addEventListener('mozpointerlockerror', world.pointerlockerror, false);\n    document.addEventListener('webkitpointerlockerror', world.pointerlockerror, false);\n\n    target.block.addEventListener('click', () => {\n      element.requestPointerLock = element.requestPointerLock\n        || element.mozRequestPointerLock\n        || element.webkitRequestPointerLock;\n\n      element.requestFullscreen = element.requestFullscreen\n        || element.mozRequestFullscreen\n        || element.mozRequestFullScreen\n        || element.webkitRequestFullscreen;\n\n      if (/Firefox/i.test(navigator.userAgent)) {\n        const fullscreenchange = () => {\n          if (document.fullscreenElement === element\n            || document.mozFullscreenElement === element\n            || document.mozFullScreenElement === element) {\n            document.removeEventListener('fullscreenchange', fullscreenchange);\n            document.removeEventListener('mozfullscreenchange', fullscreenchange);\n\n            element.requestPointerLock();\n          }\n        };\n\n        document.addEventListener('fullscreenchange', fullscreenchange, false);\n        document.addEventListener('mozfullscreenchange', fullscreenchange, false);\n\n        element.requestFullscreen();\n      } else element.requestPointerLock();\n    });\n\n    return controls;\n  }\n}\n"]}