/**
 * Â© Alexander Buzin, 2014-2015
 * Site: http://alexbuzin.me/
 * Email: alexbuzin88@gmail.com
*/

THREE.AnaglyphEffect=function(e,t,r){var a,o,i,n,s=new THREE.Matrix4,c=new THREE.Matrix4,l=125,m=new THREE.PerspectiveCamera;m.matrixAutoUpdate=!1;var d=new THREE.PerspectiveCamera;d.matrixAutoUpdate=!1;var p=new THREE.OrthographicCamera(-1,1,1,-1,0,1),h=new THREE.Scene,u={minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat};void 0===t&&(t=512),void 0===r&&(r=512);var f=new THREE.WebGLRenderTarget(t,r,u),y=new THREE.WebGLRenderTarget(t,r,u),E=new THREE.ShaderMaterial({uniforms:{mapLeft:{type:"t",value:f},mapRight:{type:"t",value:y}},vertexShader:["varying vec2 vUv;","void main() {","	vUv = vec2( uv.x, uv.y );","	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D mapLeft;","uniform sampler2D mapRight;","varying vec2 vUv;","void main() {","	vec4 colorL, colorR;","	vec2 uv = vUv;","	colorL = texture2D( mapLeft, uv );","	colorR = texture2D( mapRight, uv );","	gl_FragColor = vec4( colorL.g * 0.7 + colorL.b * 0.3, colorR.g, colorR.b, colorL.a + colorR.a ) * 1.1;","}"].join("\n")}),g=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),E);h.add(g),this.setSize=function(t,r){f&&f.dispose(),y&&y.dispose(),f=new THREE.WebGLRenderTarget(t,r,u),y=new THREE.WebGLRenderTarget(t,r,u),E.uniforms.mapLeft.value=f,E.uniforms.mapRight.value=y,e.setSize(t,r)},this.render=function(t,r){t.updateMatrixWorld(),void 0===r.parent&&r.updateMatrixWorld();var u=a!==r.aspect||o!==r.near||i!==r.far||n!==r.fov;if(u){a=r.aspect,o=r.near,i=r.far,n=r.fov;var E,g,v=r.projectionMatrix.clone(),w=l/30*.5,b=w*o/l,T=o*Math.tan(THREE.Math.degToRad(.5*n));s.elements[12]=w,c.elements[12]=-w,E=-T*a+b,g=T*a+b,v.elements[0]=2*o/(g-E),v.elements[8]=(g+E)/(g-E),m.projectionMatrix.copy(v),E=-T*a-b,g=T*a-b,v.elements[0]=2*o/(g-E),v.elements[8]=(g+E)/(g-E),d.projectionMatrix.copy(v)}m.matrixWorld.copy(r.matrixWorld).multiply(c),m.position.copy(r.position),m.near=r.near,m.far=r.far,e.render(t,m,f,!0),d.matrixWorld.copy(r.matrixWorld).multiply(s),d.position.copy(r.position),d.near=r.near,d.far=r.far,e.render(t,d,y,!0),e.render(h,p)},this.dispose=function(){f&&f.dispose(),y&&y.dispose()}},THREE.BufferGeometryUtils={computeTangents:function(e){function t(e,t,r){u.fromArray(n,3*e),f.fromArray(n,3*t),y.fromArray(n,3*r),E.fromArray(c,2*e),g.fromArray(c,2*t),v.fromArray(c,2*r);var a=f.x-u.x,o=y.x-u.x,i=f.y-u.y,s=y.y-u.y,l=f.z-u.z,m=y.z-u.z,h=g.x-E.x,T=v.x-E.x,H=g.y-E.y,R=v.y-E.y,S=1/(h*R-T*H);w.set((R*a-H*o)*S,(R*i-H*s)*S,(R*l-H*m)*S),b.set((h*o-T*a)*S,(h*s-T*i)*S,(h*m-T*l)*S),d[e].add(w),d[t].add(w),d[r].add(w),p[e].add(b),p[t].add(b),p[r].add(b)}function r(e){L.fromArray(s,3*e),W.copy(L),M=d[e],P.copy(M),P.sub(L.multiplyScalar(L.dot(M))).normalize(),O.crossVectors(W,M),A=O.dot(p[e]),C=0>A?-1:1,m[4*e]=P.x,m[4*e+1]=P.y,m[4*e+2]=P.z,m[4*e+3]=C}var a=e.index,o=e.attributes;if(null===a||void 0===o.position||void 0===o.normal||void 0===o.uv)return void console.warn("THREE.BufferGeometry: Missing required attributes (index, position, normal or uv) in BufferGeometry.computeTangents()");var i=a.array,n=o.position.array,s=o.normal.array,c=o.uv.array,l=n.length/3;void 0===o.tangent&&e.addAttribute("tangent",new THREE.BufferAttribute(new Float32Array(4*l),4));for(var m=o.tangent.array,d=[],p=[],h=0;l>h;h++)d[h]=new THREE.Vector3,p[h]=new THREE.Vector3;var u=new THREE.Vector3,f=new THREE.Vector3,y=new THREE.Vector3,E=new THREE.Vector2,g=new THREE.Vector2,v=new THREE.Vector2,w=new THREE.Vector3,b=new THREE.Vector3,T=e.groups;0===T.length&&(T=[{start:0,count:i.length}]);for(var H=0,R=T.length;R>H;++H)for(var S=T[H],x=S.start,N=S.count,_=x,k=x+N;k>_;_+=3)t(i[_+0],i[_+1],i[_+2]);for(var C,M,A,P=new THREE.Vector3,O=new THREE.Vector3,L=new THREE.Vector3,W=new THREE.Vector3,H=0,R=T.length;R>H;++H)for(var S=T[H],x=S.start,N=S.count,_=x,k=x+N;k>_;_+=3)r(i[_+0]),r(i[_+1]),r(i[_+2])}},THREE.CannonDebugRenderer=function(e,t,r){r=r||{},this.scene=e,this.world=t,this._meshes=[],this._material=new THREE.MeshBasicMaterial({color:65280,wireframe:!0}),this._sphereGeometry=new THREE.SphereGeometry(1),this._boxGeometry=new THREE.BoxGeometry(1,1,1),this._planeGeometry=new THREE.PlaneGeometry(10,10,10,10),this._cylinderGeometry=new THREE.CylinderGeometry(1,1,10,10)},THREE.CannonDebugRenderer.prototype={tmpVec0:new CANNON.Vec3,tmpVec1:new CANNON.Vec3,tmpVec2:new CANNON.Vec3,tmpQuat0:new CANNON.Vec3,update:function(){for(var e=this.world.bodies,t=this._meshes,r=this.tmpVec0,a=this.tmpQuat0,o=0,i=0;i!==e.length;i++)for(var n=e[i],s=0;s!==n.shapes.length;s++){var c=n.shapes[s];this._updateMesh(o,n,c);var l=t[o];l&&(n.quaternion.vmult(n.shapeOffsets[s],r),n.position.vadd(r,r),n.quaternion.mult(n.shapeOrientations[s],a),l.position.copy(r),l.quaternion.copy(a)),o++}for(var i=o;i<t.length;i++){var l=t[i];l&&this.scene.remove(l)}t.length=o},_updateMesh:function(e,t,r){var a=this._meshes[e];this._typeMatch(a,r)||(a&&this.scene.remove(a),a=this._meshes[e]=this._createMesh(r)),this._scaleMesh(a,r)},_typeMatch:function(e,t){if(!e)return!1;var r=e.geometry;return r instanceof THREE.SphereGeometry&&t instanceof CANNON.Sphere||r instanceof THREE.BoxGeometry&&t instanceof CANNON.Box||r instanceof THREE.PlaneGeometry&&t instanceof CANNON.Plane||r.id===t.geometryId&&t instanceof CANNON.ConvexPolyhedron||r.id===t.geometryId&&t instanceof CANNON.Trimesh||r.id===t.geometryId&&t instanceof CANNON.Heightfield},_createMesh:function(e){var t,r=this._material;switch(e.type){case CANNON.Shape.types.SPHERE:t=new THREE.Mesh(this._sphereGeometry,r);break;case CANNON.Shape.types.BOX:t=new THREE.Mesh(this._boxGeometry,r);break;case CANNON.Shape.types.PLANE:t=new THREE.Mesh(this._planeGeometry,r);break;case CANNON.Shape.types.CONVEXPOLYHEDRON:for(var a=new THREE.Geometry,o=0;o<e.vertices.length;o++){var i=e.vertices[o];a.vertices.push(new THREE.Vector3(i.x,i.y,i.z))}for(var o=0;o<e.faces.length;o++)for(var n=e.faces[o],s=n[0],c=1;c<n.length-1;c++){var l=n[c],m=n[c+1];a.faces.push(new THREE.Face3(s,l,m))}a.computeBoundingSphere(),a.computeFaceNormals(),t=new THREE.Mesh(a,r),e.geometryId=a.id;break;case CANNON.Shape.types.TRIMESH:for(var d=new THREE.Geometry,p=this.tmpVec0,h=this.tmpVec1,u=this.tmpVec2,o=0;o<e.indices.length/3;o++){e.getTriangleVertices(o,p,h,u),d.vertices.push(new THREE.Vector3(p.x,p.y,p.z),new THREE.Vector3(h.x,h.y,h.z),new THREE.Vector3(u.x,u.y,u.z));var c=d.vertices.length-3;d.faces.push(new THREE.Face3(c,c+1,c+2))}d.computeBoundingSphere(),d.computeFaceNormals(),t=new THREE.Mesh(d,r),e.geometryId=d.id;break;case CANNON.Shape.types.HEIGHTFIELD:for(var d=new THREE.Geometry,p=this.tmpVec0,h=this.tmpVec1,u=this.tmpVec2,f=0;f<e.data.length-1;f++)for(var y=0;y<e.data[f].length-1;y++)for(var E=0;2>E;E++){e.getConvexTrianglePillar(f,y,0===E),p.copy(e.pillarConvex.vertices[0]),h.copy(e.pillarConvex.vertices[1]),u.copy(e.pillarConvex.vertices[2]),p.vadd(e.pillarOffset,p),h.vadd(e.pillarOffset,h),u.vadd(e.pillarOffset,u),d.vertices.push(new THREE.Vector3(p.x,p.y,p.z),new THREE.Vector3(h.x,h.y,h.z),new THREE.Vector3(u.x,u.y,u.z));var o=d.vertices.length-3;d.faces.push(new THREE.Face3(o,o+1,o+2))}d.computeBoundingSphere(),d.computeFaceNormals(),t=new THREE.Mesh(d,r),e.geometryId=d.id}return t&&this.scene.add(t),t},_scaleMesh:function(e,t){switch(t.type){case CANNON.Shape.types.SPHERE:var r=t.radius;e.scale.set(r,r,r);break;case CANNON.Shape.types.BOX:e.scale.copy(t.halfExtents),e.scale.multiplyScalar(2);break;case CANNON.Shape.types.CONVEXPOLYHEDRON:e.scale.set(1,1,1);break;case CANNON.Shape.types.TRIMESH:e.scale.copy(t.scale);break;case CANNON.Shape.types.HEIGHTFIELD:e.scale.set(1,1,1)}}};var PointerLockControls=function(e,t,r,a){var r=r||.5,o=.1,i=10*r,n=1,s=2*n,c=this,l=new THREE.Object3D;l.add(e);var m=new THREE.Object3D;m.position.y=2,m.add(l);var d=new THREE.Quaternion,p=!1,h=!1,u=!1,f=!1,y=!1,E=new CANNON.Vec3,g=new CANNON.Vec3(0,1,0);t.addEventListener("collide",function(e){var r=e.contact;r.bi.id==t.id?r.ni.negate(E):E.copy(r.ni),E.dot(g)>.5&&(y=!0)});var v=t.velocity,w=Math.PI/2,b=function(e){if(a.motionBlurEnable=!1,c.enabled!==!1){var t=e.movementX||e.mozMovementX||0,r=e.movementY||e.mozMovementY||0;a.motionBlurEffect&&(a.motionBlurEffect.params.delta=Math.abs(5e-4*e.movementX)/2+Math.abs(5e-4*e.movementY)/2),m.rotation.y-=.002*t,l.rotation.x-=.002*r,l.rotation.x=Math.max(-w,Math.min(w,l.rotation.x))}},T=function(e){a.motionBlurEnable=!0},H=function(e){switch(e.keyCode){case 38:case 87:p=!0;break;case 37:case 65:u=!0;break;case 40:case 83:h=!0;break;case 39:case 68:f=!0;break;case 32:y===!0&&(v.y=i),y=!1;break;case 15:y===!0&&(n=3)}},R=function(e){switch(e.keyCode){case 38:case 87:p=!1;break;case 37:case 65:u=!1;break;case 40:case 83:h=!1;break;case 39:case 68:f=!1}};document.body.addEventListener("mousemove",b,!1),document.body.addEventListener("keydown",H,!1),document.body.addEventListener("keyup",R,!1),$(document).mousestop(100,T),this.enabled=!1,this.getObject=function(){return m},this.getDirection=function(e){e.set(0,0,-1),d.multiplyVector3(e)};var S=new THREE.Vector3,x=new THREE.Euler;this.update=function(e){c.enabled!==!1&&(e*=.03,S.set(0,0,0),p&&(S.z=-o*e*r*s),h&&(S.z=o*e*r*s),u&&(S.x=-o*e*r*s),f&&(S.x=o*e*r*s),x.x=l.rotation.x,x.y=m.rotation.y,x.order="XYZ",d.setFromEuler(x),S.applyQuaternion(d),v.x+=S.x,v.z+=S.z,m.position.copy(t.position))}};!function(e){function t(){var t=this,r=e(this).data("mousestop");this.movement=!0,r.timeToStop&&(this.timeToStopTimer=window.setTimeout(function(){t.movement=!1,window.clearTimeout(t.timer)},r.timeToStop))}function r(){window.clearTimeout(this.timer),window.clearTimeout(this.timeToStopTimer)}function a(){var t=e(this),r=t.data("mousestop");this.movement&&(window.clearTimeout(this.timer),this.timer=window.setTimeout(function(){t.trigger("mousestop")},r.delay))}function o(t){return e.isNumeric(t)?t={delay:t}:"object"!=typeof t&&(t={}),e.extend({},e.fn.mousestop.defaults,t)}"undefined"!=typeof e.event&&(e.event.special.mousestop={setup:function(i){e(this).data("mousestop",o(i)).bind("mouseenter.mousestop",t).bind("mouseleave.mousestop",r).bind("mousemove.mousestop",a)},teardown:function(){e(this).removeData("mousestop").unbind(".mousestop")}},e.fn.mousestop=function(e,t){return"function"==typeof e&&(t=e),arguments.length>0?this.bind("mousestop",e,t):this.trigger("mousestop")},e.fn.mousestop.defaults={delay:300,timeToStop:null})}(jQuery),THREE.OrbitControls=function(e,t){function r(){return 2*Math.PI/60/60*p.autoRotateSpeed}function a(){return Math.pow(.95,p.zoomSpeed)}function o(e){if(p.enabled!==!1){if(e.preventDefault(),0===e.button){if(p.noRotate===!0)return;k=_.ROTATE,u.set(e.clientX,e.clientY)}else if(1===e.button){if(p.noZoom===!0)return;k=_.DOLLY,w.set(e.clientX,e.clientY)}else if(2===e.button){if(p.noPan===!0)return;k=_.PAN,E.set(e.clientX,e.clientY)}p.domElement.addEventListener("mousemove",i,!1),p.domElement.addEventListener("mouseup",n,!1)}}function i(e){if(p.enabled!==!1){e.preventDefault();var t=p.domElement===document?p.domElement.body:p.domElement;if(k===_.ROTATE){if(p.noRotate===!0)return;f.set(e.clientX,e.clientY),y.subVectors(f,u),p.rotateLeft(2*Math.PI*y.x/t.clientWidth*p.rotateSpeed),p.rotateUp(2*Math.PI*y.y/t.clientHeight*p.rotateSpeed),u.copy(f)}else if(k===_.DOLLY){if(p.noZoom===!0)return;b.set(e.clientX,e.clientY),T.subVectors(b,w),T.y>0?p.dollyIn():p.dollyOut(),w.copy(b)}else if(k===_.PAN){if(p.noPan===!0)return;g.set(e.clientX,e.clientY),v.subVectors(g,E),p.pan(v),E.copy(g)}p.update()}}function n(){p.enabled!==!1&&(p.domElement.removeEventListener("mousemove",i,!1),p.domElement.removeEventListener("mouseup",n,!1),k=_.NONE)}function s(e){if(p.enabled!==!1&&p.noZoom!==!0){var t=0;e.wheelDelta?t=e.wheelDelta:e.detail&&(t=-e.detail),t>0?p.dollyOut():p.dollyIn()}}function c(e){if(p.enabled!==!1&&p.noKeys!==!0&&p.noPan!==!0){var t=!1;switch(e.keyCode){case p.keys.UP:p.pan(new THREE.Vector2(0,p.keyPanSpeed)),t=!0;break;case p.keys.BOTTOM:p.pan(new THREE.Vector2(0,-p.keyPanSpeed)),t=!0;break;case p.keys.LEFT:p.pan(new THREE.Vector2(p.keyPanSpeed,0)),t=!0;break;case p.keys.RIGHT:p.pan(new THREE.Vector2(-p.keyPanSpeed,0)),t=!0}t&&p.update()}}function l(e){if(p.enabled!==!1)switch(e.touches.length){case 1:if(p.noRotate===!0)return;k=_.TOUCH_ROTATE,u.set(e.touches[0].pageX,e.touches[0].pageY);break;case 2:if(p.noZoom===!0)return;k=_.TOUCH_DOLLY;var t=e.touches[0].pageX-e.touches[1].pageX,r=e.touches[0].pageY-e.touches[1].pageY,a=Math.sqrt(t*t+r*r);w.set(0,a);break;case 3:if(p.noPan===!0)return;k=_.TOUCH_PAN,E.set(e.touches[0].pageX,e.touches[0].pageY);break;default:k=_.NONE}}function m(e){if(p.enabled!==!1){e.preventDefault(),e.stopPropagation();var t=p.domElement===document?p.domElement.body:p.domElement;switch(e.touches.length){case 1:if(p.noRotate===!0)return;if(k!==_.TOUCH_ROTATE)return;f.set(e.touches[0].pageX,e.touches[0].pageY),y.subVectors(f,u),p.rotateLeft(2*Math.PI*y.x/t.clientWidth*p.rotateSpeed),p.rotateUp(2*Math.PI*y.y/t.clientHeight*p.rotateSpeed),u.copy(f);break;case 2:if(p.noZoom===!0)return;if(k!==_.TOUCH_DOLLY)return;var r=e.touches[0].pageX-e.touches[1].pageX,a=e.touches[0].pageY-e.touches[1].pageY,o=Math.sqrt(r*r+a*a);b.set(0,o),T.subVectors(b,w),T.y>0?p.dollyOut():p.dollyIn(),w.copy(b);break;case 3:if(p.noPan===!0)return;if(k!==_.TOUCH_PAN)return;g.set(e.touches[0].pageX,e.touches[0].pageY),v.subVectors(g,E),p.pan(v),E.copy(g);break;default:k=_.NONE}}}function d(){p.enabled!==!1&&(k=_.NONE)}this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.target=new THREE.Vector3,this.center=this.target,this.noZoom=!1,this.zoomSpeed=1,this.minDistance=0,this.maxDistance=1/0,this.noRotate=!1,this.rotateSpeed=1,this.noPan=!1,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.noKeys=!1,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40};var p=this,h=1e-6,u=new THREE.Vector2,f=new THREE.Vector2,y=new THREE.Vector2,E=new THREE.Vector2,g=new THREE.Vector2,v=new THREE.Vector2,w=new THREE.Vector2,b=new THREE.Vector2,T=new THREE.Vector2,H=0,R=0,S=1,x=new THREE.Vector3,N=new THREE.Vector3,_={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},k=_.NONE,C={type:"change"};this.rotateLeft=function(e){void 0===e&&(e=r()),R-=e},this.rotateUp=function(e){void 0===e&&(e=r()),H-=e},this.panLeft=function(e){var t=new THREE.Vector3,r=this.object.matrix.elements;t.set(r[0],r[1],r[2]),t.multiplyScalar(-e),x.add(t)},this.panUp=function(e){var t=new THREE.Vector3,r=this.object.matrix.elements;t.set(r[4],r[5],r[6]),t.multiplyScalar(e),x.add(t)},this.pan=function(e){var t=p.domElement===document?p.domElement.body:p.domElement;if(void 0!==p.object.fov){var r=p.object.position,a=r.clone().sub(p.target),o=a.length();o*=Math.tan(p.object.fov/2*Math.PI/180),p.panLeft(2*e.x*o/t.clientHeight),p.panUp(2*e.y*o/t.clientHeight)}else void 0!==p.object.top?(p.panLeft(e.x*(p.object.right-p.object.left)/t.clientWidth),p.panUp(e.y*(p.object.top-p.object.bottom)/t.clientHeight)):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled.")},this.dollyIn=function(e){void 0===e&&(e=a()),S/=e},this.dollyOut=function(e){void 0===e&&(e=a()),S*=e},this.update=function(){var e=this.object.position,t=e.clone().sub(this.target),a=Math.atan2(t.x,t.z),o=Math.atan2(Math.sqrt(t.x*t.x+t.z*t.z),t.y);this.autoRotate&&this.rotateLeft(r()),a+=R,o+=H,o=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,o)),o=Math.max(h,Math.min(Math.PI-h,o));var i=t.length()*S;i=Math.max(this.minDistance,Math.min(this.maxDistance,i)),this.target.add(x),t.x=i*Math.sin(o)*Math.sin(a),t.y=i*Math.cos(o),t.z=i*Math.sin(o)*Math.cos(a),e.copy(this.target).add(t),this.object.lookAt(this.target),R=0,H=0,S=1,x.set(0,0,0),N.distanceTo(this.object.position)>0&&(this.dispatchEvent(C),N.copy(this.object.position))},this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",o,!1),this.domElement.addEventListener("mousewheel",s,!1),this.domElement.addEventListener("DOMMouseScroll",s,!1),this.domElement.addEventListener("keydown",c,!1),this.domElement.addEventListener("touchstart",l,!1),this.domElement.addEventListener("touchend",d,!1),this.domElement.addEventListener("touchmove",m,!1)},THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype),!function(){function e(e){var t={};return e&&"[object Function]"===t.toString.call(e)}this.SimpleWorker=function(t){function r(){onmessage=function(e){"__args"==e.data.type&&__func.apply(this,e.data.args)}}var a,o,i,n,s;if(a=t.func,!e(a))throw new Error("`func` needs to be a function.");o=t.args,i=t.success||function(){},n=t.error||function(){},s=t.runOnce||!1;var c;c="data:text/javascript;charset=US-ASCII,var __func = "+a.toString()+";",c+="("+r.toString()+").call(this);";var l=new Worker(c);l.onmessage=function(e){i(e.data),s&&l.terminate()},l.onerror=function(e){n(e)},this.run=function(){l.postMessage({type:"__args",args:Array.prototype.slice.call(arguments)})},this.close=function(){l.terminate()},void 0!==o&&this.run.apply(this,o)},this.SimpleWorker.run=function(e){e.runOnce=!0,new SimpleWorker(e)}}.call(this);var Stats=function(){function e(e,t,r){return e=document.createElement(e),e.id=t,e.style.cssText=r,e}function t(t,r,a){var o=e("div",t,"padding:0 0 3px 3px;text-align:left;background:"+a),i=e("div",t+"Text","font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px;color:"+r);for(i.innerHTML=t.toUpperCase(),o.appendChild(i),t=e("div",t+"Graph","width:74px;height:30px;background:"+r),o.appendChild(t),r=0;74>r;r++)t.appendChild(e("span","","width:1px;height:30px;float:left;opacity:0.9;background:"+a));return o}function r(e){for(var t=l.children,r=0;r<t.length;r++)t[r].style.display=r===e?"block":"none";c=e}function a(e,t){e.appendChild(e.firstChild).style.height=Math.min(30,30-30*t)+"px"}var o=self.performance&&self.performance.now?self.performance.now.bind(performance):Date.now,i=o(),n=i,s=0,c=0,l=e("div","stats","width:80px;opacity:0.9;cursor:pointer");l.addEventListener("mousedown",function(e){e.preventDefault(),r(++c%l.children.length)},!1);var m=0,d=1/0,p=0,h=t("fps","#0ff","#002"),u=h.children[0],f=h.children[1];l.appendChild(h);var y=0,E=1/0,g=0,h=t("ms","#0f0","#020"),v=h.children[0],w=h.children[1];if(l.appendChild(h),self.performance&&self.performance.memory){var b=0,T=1/0,H=0,h=t("mb","#f08","#201"),R=h.children[0],S=h.children[1];l.appendChild(h)}return r(c),{REVISION:14,domElement:l,setMode:r,begin:function(){i=o()},end:function(){var e=o();if(y=e-i,E=Math.min(E,y),g=Math.max(g,y),v.textContent=(0|y)+" MS ("+(0|E)+"-"+(0|g)+")",a(w,y/200),s++,e>n+1e3&&(m=Math.round(1e3*s/(e-n)),d=Math.min(d,m),p=Math.max(p,m),u.textContent=m+" FPS ("+d+"-"+p+")",a(f,m/100),n=e,s=0,void 0!==b)){var t=performance.memory.usedJSHeapSize,r=performance.memory.jsHeapSizeLimit;b=Math.round(9.54e-7*t),T=Math.min(T,b),H=Math.max(H,b),R.textContent=b+" MB ("+T+"-"+H+")",a(S,t/r)}return e},update:function(){i=this.end()}}};"object"==typeof module&&(module.exports=Stats),THREE.SubdivisionModifier=function(e){"use strict";this.subdivisions=void 0===e?1:e},THREE.SubdivisionModifier.prototype.modify=function(e){for(var t=this.subdivisions;t-- >0;)this.smooth(e);delete e.__tmpVertices,e.computeFaceNormals(),e.computeVertexNormals()},function(){function e(e,t,r){var a=Math.min(e,t),o=Math.max(e,t),i=a+"_"+o;return r[i]}function t(e,t,r,a,o,i){var n,s=Math.min(e,t),c=Math.max(e,t),l=s+"_"+c;if(l in a)n=a[l];else{var m=r[s],d=r[c];n={a:m,b:d,newEdge:null,faces:[]},a[l]=n}n.faces.push(o),i[e].edges.push(n),i[t].edges.push(n)}function r(e,r,a,o){var i,n,s;for(i=0,n=e.length;n>i;i++)a[i]={edges:[]};for(i=0,n=r.length;n>i;i++)s=r[i],t(s.a,s.b,e,o,s,a),t(s.b,s.c,e,o,s,a),t(s.c,s.a,e,o,s,a)}function a(e,t,r,a){e.push(new THREE.Face3(t,r,a))}var o=!1,i=["a","b","c"];THREE.SubdivisionModifier.prototype.smooth=function(t){var n,s,c,l,m,d,p,h,u,f,y,y,E,g,v=new THREE.Vector3;n=t.vertices,s=t.faces,f=new Array(n.length),y={},r(n,s,f,y),E=[];var w,b,T,H,R,S,x;for(d in y){for(b=y[d],T=new THREE.Vector3,R=3/8,S=1/8,x=b.faces.length,2!=x&&(R=.5,S=0,1!=x&&o&&console.warn("Subdivision Modifier: Number of connected faces != 2, is: ",x,b)),T.addVectors(b.a,b.b).multiplyScalar(R),v.set(0,0,0),h=0;x>h;h++){for(H=b.faces[h],u=0;3>u&&(w=n[H[i[u]]],w===b.a||w===b.b);u++);v.add(w)}v.multiplyScalar(S),T.add(v),b.newEdge=E.length,E.push(T)}var N,_,k,C,M,A,P;for(g=[],d=0,p=n.length;p>d;d++){for(A=n[d],M=f[d].edges,m=M.length,3==m?N=3/16:m>3&&(N=3/(8*m)),_=1-m*N,k=N,2>=m&&(2==m?(o&&console.warn("2 connecting edges",M),_=.75,k=1/8):1==m?o&&console.warn("only 1 connecting edge"):0==m&&o&&console.warn("0 connecting edges")),P=A.clone().multiplyScalar(_),v.set(0,0,0),h=0;m>h;h++)C=M[h],w=C.a!==A?C.a:C.b,v.add(w);v.multiplyScalar(k),P.add(v),g.push(P)}c=g.concat(E);var O,L,W,V=g.length;for(l=[],d=0,p=s.length;p>d;d++)H=s[d],O=e(H.a,H.b,y).newEdge+V,L=e(H.b,H.c,y).newEdge+V,W=e(H.c,H.a,y).newEdge+V,a(l,O,L,W),a(l,H.a,O,W),a(l,H.b,L,O),a(l,H.c,W,L);t.vertices=c,t.faces=l}}(),"undefined"==typeof Array.isArray&&(Array.isArray=function(e){"use strict";return"[object Array]"===Object.prototype.toString.call(e)}),Object.assign||Object.defineProperty(Object,"assign",{enumerable:!1,configurable:!0,writable:!0,value:function(e){"use strict";if(void 0===e||null===e)throw new TypeError("Cannot convert first argument to object");for(var t=Object(e),r=1;r<arguments.length;r++){var a=arguments[r];if(void 0!==a&&null!==a){a=Object(a);for(var o=Object.keys(a),i=0,n=o.length;n>i;i++){var s=o[i],c=Object.getOwnPropertyDescriptor(a,s);void 0!==c&&c.enumerable&&(t[s]=a[s])}}}return t}});var WHS={REVISION:"0.0.6"};WHS.headers={},WHS.API={},WHS.ADD={},WHS.plugins={settings:{plug_id:0,loop_id:0},list:{},queue:[]},WHS.grounds=[];var api=WHS.API;"function"==typeof define&&define.amd?define("whitestorm",WHS):"undefined"!=typeof exports&&"undefined"!=typeof module&&(module.exports=WHS),THREE.ShaderTerrain={terrain:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.fog,THREE.UniformsLib.lights,THREE.UniformsLib.shadowmap,{enableDiffuse1:{type:"i",value:0},enableDiffuse2:{type:"i",value:0},enableSpecular:{type:"i",value:0},enableReflection:{type:"i",value:0},tDiffuse1:{type:"t",value:null},tDiffuse2:{type:"t",value:null},tDetail:{type:"t",value:null},tNormal:{type:"t",value:null},tSpecular:{type:"t",value:null},tDisplacement:{type:"t",value:null},uNormalScale:{type:"f",value:1},uDisplacementBias:{type:"f",value:0},uDisplacementScale:{type:"f",value:1},diffuse:{type:"c",value:new THREE.Color(15658734)},specular:{type:"c",value:new THREE.Color(1118481)},shininess:{type:"f",value:30},opacity:{type:"f",value:1},uRepeatBase:{type:"v2",value:new THREE.Vector2(1,1)},uRepeatOverlay:{type:"v2",value:new THREE.Vector2(1,1)},uOffset:{type:"v2",value:new THREE.Vector2(0,0)}}]),fragmentShader:["uniform vec3 diffuse;","uniform vec3 emissive;","uniform float opacity;","uniform vec3 ambientLightColor;","varying vec3 vLightFront;","#ifdef DOUBLE_SIDED","varying vec3 vLightBack;","uniform vec2 uRepeatOverlay;","uniform vec2 uRepeatBase;","uniform vec2 uOffset;","uniform float uNormalScale;","uniform sampler2D tNormal;","#endif","uniform sampler2D oceanTexture;","uniform sampler2D sandyTexture;","uniform sampler2D grassTexture;","uniform sampler2D rockyTexture;","uniform sampler2D snowyTexture;","varying vec3 vTangent;","varying vec3 vBinormal;","varying vec3 vNormal;","varying vec3 vViewPosition;",THREE.ShaderChunk.common,THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.map_pars_fragment,THREE.ShaderChunk.alphamap_pars_fragment,THREE.ShaderChunk.lightmap_pars_fragment,THREE.ShaderChunk.envmap_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.shadowmap_pars_fragment,THREE.ShaderChunk.specularmap_pars_fragment,THREE.ShaderChunk.logdepthbuf_pars_fragment,"","varying vec2 vUv;","varying float vAmount;","","void main() {","vec3 specularTex = vec3( 1.0 );","vec2 uvOverlay = uRepeatOverlay * vUv + uOffset;","vec2 uvBase = uRepeatBase * vUv;","vec3 normalTex = texture2D( tNormal, uvOverlay ).xyz * 2.0 - 1.0;","normalTex.xy *= uNormalScale;","normalTex = normalize( normalTex );","mat3 tsb = mat3( vTangent, vBinormal, vNormal );","vec3 finalNormal = tsb * normalTex;","vec3 normal = normalize( finalNormal );","vec3 viewPosition = normalize( vViewPosition );","vec3 shadowMask = vec3( 1.0 );","vec3 outgoingLight = vec3( 0.0 );","vec4 diffuseColor = vec4(0.0);","   vec3 totalAmbientLight = ambientLightColor;"," vec4 water = (smoothstep(0.01, 0.25, vAmount)"," - smoothstep(0.24, 0.26, vAmount))"," * texture2D( oceanTexture, vUv * 10.0 );"," vec4 sandy = (smoothstep(0.24, 0.27, vAmount)"," - smoothstep(0.28, 0.31, vAmount))"," * texture2D( sandyTexture, vUv * 10.0 );"," vec4 grass = (smoothstep(0.28, 0.32, vAmount)"," - smoothstep(0.35, 0.40, vAmount))"," * texture2D( grassTexture, vUv * 20.0 );"," vec4 rocky = (smoothstep(0.30, 0.40, vAmount)"," - smoothstep(0.40, 0.70, vAmount))"," * texture2D( rockyTexture, vUv * 20.0 );"," vec4 snowy = (smoothstep(0.42, 0.45, vAmount))","* texture2D( snowyTexture, vUv * 10.0 );"," diffuseColor = vec4(0.0, 0.0, 0.0, 1.0)"," + water + sandy + grass + rocky + snowy; ",THREE.ShaderChunk.logdepthbuf_fragment,THREE.ShaderChunk.map_fragment,THREE.ShaderChunk.alphamap_fragment,THREE.ShaderChunk.alphatest_fragment,THREE.ShaderChunk.specularmap_fragment,THREE.ShaderChunk.lightmap_fragment,THREE.ShaderChunk.color_fragment,THREE.ShaderChunk.shadowmap_fragment,THREE.ShaderChunk.linear_to_gamma_fragment,THREE.ShaderChunk.fog_fragment,"   #ifdef DOUBLE_SIDED","       if ( gl_FrontFacing )","           outgoingLight += diffuseColor.rgb * ( vLightFront * shadowMask + totalAmbientLight ) + emissive;","       else","           outgoingLight += diffuseColor.rgb * ( vLightBack * shadowMask + totalAmbientLight ) + emissive;","   #else","       outgoingLight += diffuseColor.rgb * ( vLightFront * shadowMask + totalAmbientLight ) + emissive;","   #endif","gl_FragColor = vec4(outgoingLight, diffuseColor.a );","}"].join("\n"),vertexShader:["#define TERRAIN;","varying vec3 vLightFront;","#ifdef DOUBLE_SIDED","   varying vec3 vLightBack;","#endif","","varying float vAmount;","","attribute vec4 tangent;","uniform vec2 uRepeatBase;","uniform sampler2D tNormal;","#ifdef VERTEX_TEXTURES","uniform sampler2D tDisplacement;","uniform float uDisplacementScale;","uniform float uDisplacementBias;","#endif","varying vec3 vTangent;","varying vec3 vBinormal;","varying vec3 vNormal;","varying vec2 vUv;","varying vec3 vViewPosition;",THREE.ShaderChunk.common,THREE.ShaderChunk.envmap_pars_vertex,THREE.ShaderChunk.lights_lambert_pars_vertex,THREE.ShaderChunk.color_pars_vertex,THREE.ShaderChunk.morphtarget_pars_vertex,THREE.ShaderChunk.skinning_pars_vertex,THREE.ShaderChunk.shadowmap_pars_vertex,THREE.ShaderChunk.logdepthbuf_pars_vertex,"void main() {",THREE.ShaderChunk.color_vertex,THREE.ShaderChunk.beginnormal_vertex,THREE.ShaderChunk.morphnormal_vertex,THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.skinnormal_vertex,THREE.ShaderChunk.defaultnormal_vertex,THREE.ShaderChunk.begin_vertex,THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.project_vertex,THREE.ShaderChunk.logdepthbuf_vertex,"vNormal = normalize( normalMatrix * normal);","vTangent = normalize( normalMatrix * tangent.xyz );","vBinormal = cross( vNormal, vTangent ) * tangent.w;","vBinormal = normalize( vBinormal );","vUv = uv;","vec2 uvBase = uv * uRepeatBase;","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","mvPosition = modelViewMatrix * vec4( position, 1.0 );","transformedNormal = normalize( normalMatrix * normal );","gl_Position = projectionMatrix * mvPosition;","vViewPosition = -mvPosition.xyz;","vAmount = position.z * 0.005 + 0.1;",THREE.ShaderChunk.envmap_vertex,THREE.ShaderChunk.lights_lambert_vertex,THREE.ShaderChunk.shadowmap_vertex,"}"].join("\n"),side:THREE.DoubleSide,shading:THREE.SmoothShading}},WHS.API.construct=function(e,t,r){"use strict";e||console.error("@constructor: WHS root object is not defined.");var a=function(e,t,r){this.x=e,this.y=t,this.z=r};t.pos&&(t.pos.set=a),t.rot&&(t.rot.set=a),t.scale&&(t.scale.set=a),t.target&&(t.target.set=a);var o=$.extend({pos:{x:0,y:0,z:0,set:a},rot:{x:0,y:0,z:0,set:a},scale:{x:1,y:1,z:1,set:a},target:{x:0,y:0,z:0,set:a},morph:{speed:1,duration:1},onlyvis:!1},t),i=0;e.modellingQueue.forEach(function(e){e.type==r&&i++});var n=$.Deferred(),s={root:e,_key:i,_whsobject:!0,_name:r+i,__releaseTime:(new Date).getTime(),__deferred:n,_state:n.promise(),_pos:o.pos,_rot:o.rot,_scale:o.scale,_morph:o.morph,_target:o.target,_onlyvis:o.onlyvis};return Object.assign(this,s),this},WHS.API.construct.prototype.build=function(e,t){"use strict";e=e||this.visible,t=t||this.body;var r=!(2!=arguments.length||!t);try{e.castShadow=!0,e.receiveShadow=!0,e.position.set(this._pos.x,this._pos.y,this._pos.z),r&&!this.dtb&&t.position.set(this._pos.x,this._pos.y,this._pos.z),e.rotation.set(this._rot.x,this._rot.y,this._rot.z),e.scale.set(this._scale.x,this._scale.y,this._scale.z)}catch(a){console.error(a.message),this.__deferred.reject()}return this},WHS.API.ConvexFigure=function(e){"use strict";if(arguments.length<1)console.error("No THREE.js geometry");else if(1==arguments.length){var t=new Array,r=new Array;return e.vertices.forEach(function(e){t.push(new CANNON.Vec3(e.x,e.y,e.z))}),e.faces.forEach(function(e){r.push([e.a,e.b,e.c])}),new CANNON.ConvexPolyhedron(t,r)}},WHS.API.def=function(e,t,r){"use strict";if(arguments.length<2)console.error("Something wrong! option? value?");else{if(2==arguments.length)return e=e||t;if(3==arguments.length&&r)return r=e||t}},WHS.API.getheight=function(e,t,r,a){"use strict";return t=t||1e3,a=a||1,this.raycaster=new THREE.Raycaster(new THREE.Vector3(e.x,t,a*e.y),new THREE.Vector3(0,-1*a,0).normalize()),this.intersect=this.raycaster.intersectObject(r.visible),this.intersect},WHS.API.isSame=function(e,t){return!(e.sort()>t.sort()||e.sort()<t.sort())},WHS.API.JSONLoader=function(){return new THREE.JSONLoader},WHS.API.TextureLoader=function(){return new THREE.TextureLoader},WHS.API.loadMaterial=function(e){"use strict";"string"!=typeof e.kind&&console.error("Type of material is undefined or not a string. @loadMaterial");var t={_type:e.kind},r=$.extend({},e);switch(delete r.kind,e.kind){case"basic":t._material=new THREE.MeshBasicMaterial(r);break;case"linebasic":t._params=new THREE.LineBasicMaterial(r);break;case"linedashed":t._material=new THREE.LineDashedMaterial(r);break;case"material":t._material=new THREE.Material(r);break;case"depth":t._material=new THREE.MeshDepthMaterial(r);break;case"face":t._material=new THREE.MeshFaceMaterial(r);break;case"lambert":t._material=new THREE.MeshLambertMaterial(r);break;case"normal":t._material=new THREE.MeshNormalMaterial(r);break;case"phong":t._material=new THREE.MeshPhongMaterial(r);break;case"pointcloud":t._material=new THREE.PointCloudMaterial(r);break;case"rawshader":t._material=new THREE.RawShaderMaterial(r);break;case"shader":t._material=new THREE.ShaderMaterial(r);break;case"spritecanvas":t._material=new THREE.SpriteCanvasMaterial(r);break;case"sprite":t._material=new THREE.SpriteMaterial(r)}return t},WHS.API.merge=function(e,t){"use strict";if(arguments.length<2)console.error("No rabbits for the box. (arguments)",[e,t]);else if(2==arguments.length)if(Array.isArray(t)&&t.length<=1)e.add(t[0]);else if(Array.isArray(t)&&t.length>=2)for(var r=0;r<t.length;r++)e.add(t[r]);else!Array.isArray(t)&&e?e.add(t):console.error("box is undefined. Line "+(new Error).lineNumber+". Func merge.",[e,t])},WHS.API.PackUvs=function(e){e.computeBoundingBox();var t=e.boundingBox.max,r=e.boundingBox.min,a=new THREE.Vector2(0-r.x,0-r.y),o=new THREE.Vector2(t.x-r.x,t.y-r.y);e.faceVertexUvs[0]=[];for(var i=e.faces,n=0;n<e.faces.length;n++){var s=e.vertices[i[n].a],c=e.vertices[i[n].b],l=e.vertices[i[n].c];e.faceVertexUvs[0].push([new THREE.Vector2((s.x+a.x)/o.x,(s.y+a.y)/o.y),new THREE.Vector2((c.x+a.x)/o.x,(c.y+a.y)/o.y),new THREE.Vector2((l.x+a.x)/o.x,(l.y+a.y)/o.y)]);
}e.uvsNeedUpdate=!0},WHS.API.removeDuplicateFaces=function(e){for(var t=0;t<e.faces.length;t++)for(var r=e.faces[t],a=[r.a,r.b,r.c,r.d].sort(),o=0;t>o;o++){var i=e.faces[o];if(void 0!==i){var n=[i.a,i.b,i.c,i.d].sort();WHS.API.isSame(a,n)&&(delete e.faces[t],delete e.faces[o])}}return e.faces=e.faces.filter(function(e){return void 0===e}),e},WHS.API.rotateBody=function(e,t){"use strict";return e.quaternion.x=Math.sin(Math.PI/180*t.x*.5),e.quaternion.y=Math.sin(Math.PI/180*t.y*.5),e.quaternion.z=Math.sin(Math.PI/180*t.z*.5),e.quaternion.w=Math.cos(45),e},WHS.API.rotateGeometry=function(e,t){var r=new THREE.Matrix4;r.makeRotationFromEuler(new THREE.Euler(t.x,t.y,t.z,"XYZ"));for(var a in e.vertices)e.vertices[a].applyMatrix4(r);return e},WHS.ADD.shape=function(){return new THREE.Shape},WHS.API.texture=function(e,t){"use strict";var r=THREE.ImageUtils.loadTexture(e);if(t){var a=t;a.offset=a.offset||{x:1,y:1},a.offset.x=a.offset.x||1,a.offset.y=a.offset.y||1,a.repeat=a.repeat||{x:1,y:1},a.repeat.x=a.repeat.x||1,a.repeat.y=a.repeat.y||1,r.wrapS=r.wrapT=THREE.RepeatWrapping,r.repeat.set(a.repeat.x,a.repeat.y),r.magFilter=THREE.NearestFilter,r.minFilter=THREE.LinearMipMapLinearFilter}return r},WHS.API.Triangulate=function(e,t){"use strict";if(arguments.length<1)console.error("No THREE.js geometry");else if(arguments.length=1){var r=new THREE.Geometry,a=[];e.faces.forEach(function(o){var i=new THREE.Geometry;[].push.apply(i.vertices,[e.vertices[o.a],e.vertices[o.b],e.vertices[o.c]]),i.faceVertexUvs[0].push([new THREE.Vector2(0,0),new THREE.Vector2(0,1),new THREE.Vector2(1,1),new THREE.Vector2(1,0)]),i.faces.push(new THREE.Face3(0,1,2)),i.computeFaceNormals();var n=new THREE.Mesh(i,t);n.updateMatrix(),r.merge(n.geometry,n.matrix),a.push(t)});var o=new THREE.Mesh(r,new THREE.MeshFaceMaterial(a));return o}},WHS.API.TrimeshFigure=function(e,t){"use strict";if(arguments.length<1)console.error("No THREE.js geometry");else if(1==arguments.length){var r=[],a=[],o=[];e.vertices.forEach(function(e){r.push(e.x),r.push(e.y),r.push(e.z),t&&o.push({x:e.x,y:e.y,z:e.z})}),e.faces.forEach(function(e){a.push(e.a),a.push(e.b),a.push(e.c)});var i=new CANNON.Trimesh(r,a);return i.updateNormals(),i.heightsValues=o,i}},WHS.API.Wrap=function(e,t,r){"use strict";this._figure=t,this._object=r,this._scope=e,this._key=e.root.modellingQueue.length;try{api.merge(this._scope.root.scene,this._figure),this._object&&api.merge(this._scope.root.world,this._object),this._scope.root.modellingQueue.push(this._scope),this._scope.root.children.push(this._scope)}catch(a){console.error(a.message),this._scope.__deferred.reject()}finally{this._scope.__deferred.resolve()}return this},WHS.API.Wrap.prototype.remove=function(){"use strict";return this._scope.root.scene.remove(this._figure),this._scope.root.world.remove(this._object),WHS.objects.splice(this._key,1),this},WHS.API.Wrap.prototype.retrieve=function(){"use strict";return this._scope.root.scene.add(this._figure),this._scope.root.world.add(this._object),WHS.objects.push(this._scope),this},WHS.Watch=function(e){"use strict";return this._queue=$.isArray(e)?e:[],this},WHS.Watch.prototype.add=function(e){"use strict";return this._queue.push(e),this},WHS.Watch.prototype.remove=function(e){"use strict";return this._queue=this._queue.filter(function(t){return t!=e}),this},WHS.plugins.loop=function(e){this.loop={func:e,id:WHS.plugins.settings.loop_id++,enabled:!1},WHS.plugins.queue.push(this.loop)},WHS.plugins.loop.prototype.start=function(){this.loop.enabled=!0},WHS.plugins.loop.prototype.stop=function(){this.loop.enabled=!1},WHS.gp={},WHS.plugins.register=function(e,t,r){"use strict";var a=WHS.plugins.settings.plug_id;WHS.plugins.list[e]={func:t,id:a},r?WHS.gp[e]=t:WHS.API.construct.prototype[e]=t,WHS.plugins.settings.plug_id++},WHS.init=function(e){"use strict";console.log("WHS.init",WHS.REVISION),THREE||console.warn("whitestormJS requires THREE.js. {Object} THREE not found."),CANNON||console.warn("whitestormJS requires CANNON.js. {Object} CANNON not found."),CANNON||console.warn("whitestormJS requires WAGNER.js. {Object} WAGNER not found.");var t=$.extend(!0,{anaglyph:!1,helper:!1,stats:!1,wagner:!0,autoresize:!1,shadowmap:!0,gravity:{x:0,y:0,z:0},camera:{aspect:75,near:1,far:1e3,x:0,y:0,z:0},rWidth:window.innerWidth,rHeight:window.innerHeight,width:window.innerWidth,height:window.innerHeight,physics:{quatNormalizeSkip:0,quatNormalizeFast:!1,solver:{iterations:20,tolerance:0},defMaterial:{contactEquationStiffness:1e8,contactEquationRegularizationTime:3}},background:0,assets:"./assets",container:$("body")},e);this._settings=t,this.scene=new THREE.Scene,this.world=new CANNON.World,this.world.gravity.set(e.gravity.x,e.gravity.y,e.gravity.z),this.world.broadphase=new CANNON.NaiveBroadphase,this.world.quatNormalizeSkip=t.physics.quatNormalizeSkip,this.world.quatNormalizeFast=t.physics.quatNormalizeFast;var r=new CANNON.GSSolver;this.world.defaultContactMaterial.contactEquationStiffness=t.physics.defMaterial.contactEquationStiffness,this.world.defaultContactMaterial.contactEquationRegularizationTime=t.physics.defMaterial.contactEquationRegularizationTime,r.iterations=t.physics.solver.iterations,r.tolerance=t.physics.solver.tolerance,this.world.solver=new CANNON.SplitSolver(r);var a=new CANNON.Material("slipperyMaterial"),o=new CANNON.ContactMaterial(a,a,0,.3);this.world.addContactMaterial(o);var i=$('<div class="whs"></div>');t.container.append($(i)),t.helper&&(this._cannonDebugRenderer=new THREE.CannonDebugRenderer(this.scene,this.world)),t.stats&&(this._stats=new Stats,"fps"==t.stats?this._stats.setMode(0):"ms"==t.stats?this._stats.setMode(1):"mb"==t.stats?this._stats.setMode(1):(this._stats.setMode(0),console.warn([this._stats],"Please, apply stats mode [fps, ms, mb] .")),this._stats.domElement.style.position="absolute",this._stats.domElement.style.left="0px",this._stats.domElement.style.bottom="0px",$(i).append(this._stats.domElement));var n=new THREE.PerspectiveCamera(t.camera.aspect,t.width/t.height,t.camera.near,t.camera.far);n.position.set(t.camera.x,t.camera.y,t.camera.z),api.merge(this.scene,n);var s=new THREE.WebGLRenderer;s.setClearColor(t.background),s.shadowMap.enabled=t.shadowmap,s.shadowMap.type=THREE.PCFSoftShadowMap,s.shadowMap.cascade=!0,t.anaglyph?(this.effect=new THREE.AnaglyphEffect(s),this.effect.setSize(t.rWidth,t.rHeight),this.effect.render(this.scene,n)):(s.setSize(t.rWidth,t.rHeight),s.render(this.scene,n)),$(s.domElement).css({width:t.width,height:t.height}),$(s.domElement).attr(""),$(i).append(s.domElement),t.container.css({margin:0,padding:0,position:"relative",overflow:"hidden"}),t.wagner&&(this._composer=new WAGNER.Composer(s),this._composer.setSize(t.rWidth,t.rHeight),$(this._composer.domElement).css({width:t.width,height:t.height}),this._composer.autoClearColor=!0,this._composer.reset(),this._composer.render(this.scene,n),this._composer.eff=[]),Object.assign(this,{_camera:n,renderer:s,_settings:t,modellingQueue:[],children:[],_dom:i});var c=this;return c.animate(null,c),t.autoresize&&$(window).on("load resize",function(){c._camera.aspect=window.innerWidth/window.innerHeight,c._camera.updateProjectionMatrix(),c.renderer.setSize(t.rWidth,t.rHeight),$(c.renderer.domElement).css({width:window.innerWidth,height:window.innerHeight}),e.wagner&&(c._composer.setSize(t.rWidth,t.rHeight),$(c._composer.domElement).css({width:window.innerWidth,height:window.innerHeight}))}),c},WHS.init.prototype.animate=function(e,t){"use strict";function r(){requestAnimationFrame(r),t._stats&&t._stats.begin(),t._settings.helper&&t._cannonDebugRenderer.update();for(var o=0;o<Object.keys(t.modellingQueue).length;o++)t.modellingQueue[o]._onlyvis||t.modellingQueue[o].skip||(t.modellingQueue[o].visible.position.copy(t.modellingQueue[o].body.position),t.modellingQueue[o].visible.quaternion&&t.modellingQueue[o].visible.quaternion.copy(t.modellingQueue[o].body.quaternion)),t.modellingQueue[o].morph&&t.modellingQueue[o].visible.mixer.update(a.getDelta());t.world.step(1/60),t._settings.anaglyph&&t.effect.render(t.scene,t._camera),t.controls&&(t.controls.update(Date.now()-t.time),t.time=Date.now()),t._composer&&(t._composer.reset(),t._composer.render(t.scene,t._camera),t._composer.eff.forEach(function(e){t._composer.pass(e)}),t._composer.toScreen()),t._stats&&t._stats.end(),WHS.plugins.queue.forEach(function(t){t.enabled&&t.func(e)})}var a=new THREE.Clock;this.update=r,this.update()},WHS.init.prototype.addModel=function(e,t){"use strict";var r=new api.construct(this,t,"model");return r.materialType=api.loadMaterial(t.materialOptions)._material,api.JSONLoader().load(e,function(e){e.computeFaceNormals(),e.computeVertexNormals(),r.visible=new THREE.Mesh(e,r.materialType),t.onlyvis||(r.physic=new WHS.API.TrimeshFigure(e),r.body=new CANNON.Body({mass:t.mass}),r.body.linearDamping=.9,r.body.addShape(r.physic),r.body.name=r.name),r.build(),r.wrap=new api.Wrap(r,r.visible,r.body)}),r},WHS.init.prototype.addMorph=function(e,t){"use strict";var r=new api.construct(this,t,"morph");return r.skip=!0,r.morph=!0,api.JSONLoader().load(e,function(e){var t=new THREE.MeshLambertMaterial({color:16755285,morphTargets:!0,vertexColors:THREE.FaceColors});r.visible=new THREE.Mesh(e,t),r.visible.speed=r._morph.speed,r._scale.set(.1,.1,.1),r._mixer=new THREE.AnimationMixer(r.visible),r._mixer.addAction(new THREE.AnimationAction(e.animations[0]).warpToDuration(.5)),r._mixer.update(600*Math.random()),r.visible.mixer=r._mixer,r._rot.y=Math.PI/2,r.build(r.visible),r.wrap=new api.Wrap(r,r.visible)}),r},WHS.init.prototype.addObject=function(e,t){"use strict";var r=new api.construct(this,t,e),a=t||{};switch(a.geometry=t.geometryOptions||{},r.materialType=api.loadMaterial(t.materialOptions)._material,e){case"sphere":api.def(a.geometry.segmentA,32),api.def(a.geometry.segmentB,32),r.visible=new THREE.Mesh(new THREE.SphereGeometry(a.geometry.radius,a.geometry.segmentA,a.geometry.segmentB),r.materialType),t.onlyvis||(r.physic=new CANNON.Sphere(a.geometry.radius),r.body=new CANNON.Body({mass:a.mass}),r.body.linearDamping=.9,r.body.addShape(r.physic),r.body.name=r.name);break;case"cube":api.def(a.geometry.width,1),api.def(a.geometry.height,1),api.def(a.geometry.depth,1),r.visible=new THREE.Mesh(new THREE.BoxGeometry(a.geometry.width,a.geometry.height,a.geometry.depth),r.materialType),t.onlyvis||(r.physic=new CANNON.Box(new CANNON.Vec3(.5*a.geometry.width,.5*a.geometry.height,.5*a.geometry.depth)),r.body=new CANNON.Body({mass:a.mass}),r.body.linearDamping=.9,r.body.addShape(r.physic));break;case"cylinder":api.def(a.geometry.radiusTop,1),api.def(a.geometry.radiusBottom,1),api.def(a.geometry.height,1),api.def(a.geometry.radiusSegments,32),r.visible=new THREE.Mesh(new THREE.CylinderGeometry(a.geometry.radiusTop,a.geometry.radiusBottom,a.geometry.height,a.geometry.radiusSegments),r.materialType),t.onlyvis||(r.physic=new CANNON.Cylinder(a.geometry.radiusTop,a.geometry.radiusBottom,a.geometry.height,a.geometry.radiusSegments),r.body=new CANNON.Body({mass:a.mass}),r.body.linearDamping=.9,r.body.addShape(r.physic));break;case"dodecahedron":api.def(a.geometry.radius,1),api.def(a.geometry.detail,0),r.visible=new THREE.Mesh(new THREE.DodecahedronGeometry(a.geometry.radius,a.geometry.detail),r.materialType),t.onlyvis||(r.physic=new WHS.API.ConvexFigure(r.visible.geometry),r.body=new CANNON.Body({mass:a.mass}),r.body.linearDamping=.9,r.body.addShape(r.physic));break;case"extrude":api.def(a.geometry.shapes,[]),api.def(a.geometry.options,{}),r.visible=new THREE.Mesh(new THREE.ExtrudeGeometry(a.geometry.shapes,a.geometry.options),r.materialType),t.onlyvis||(r.physic=new WHS.API.ConvexFigure(r.visible.geometry),r.body=new CANNON.Body({mass:a.mass}),r.body.linearDamping=.9,r.body.addShape(r.physic));break;case"icosahedron":api.def(a.geometry.radius,1),api.def(a.geometry.detail,0),r.visible=new THREE.Mesh(new THREE.IcosahedronGeometry(a.geometry.radius,a.geometry.detail),r.materialType),t.onlyvis||(r.physic=new WHS.API.ConvexFigure(this.visible.geometry),r.body=new CANNON.Body({mass:a.mass}),r.body.linearDamping=.9,r.body.addShape(r.physic));break;case"lathe":api.def(a.geometry.points,[]),r.visible=new THREE.Mesh(new THREE.LatheGeometry(a.geometry.points),r.materialType),t.onlyvis||(r.physic=new WHS.API.ConvexFigure(this.visible.geometry),r.body=new CANNON.Body({mass:a.mass}),r.body.linearDamping=.9,r.body.addShape(r.physic));break;case"octahedron":api.def(a.geometry.radius,1),api.def(a.geometry.detail,0),r.visible=new THREE.Mesh(new THREE.OctahedronGeometry(a.geometry.radius,a.geometry.detail),r.materialType),t.onlyvis||(r.physic=new WHS.API.ConvexFigure(this.visible.geometry),r.body=new CANNON.Body({mass:a.mass}),r.body.linearDamping=.9,r.body.addShape(r.physic));break;case"parametric":api.def(a.geometry.func,function(){}),api.def(a.geometry.slices,10),api.def(a.geometry.stacks,10),r.visible=new THREE.Mesh(new THREE.ParametricGeometry(a.geometry.func,a.geometry.slices,a.geometry.stacks),r.materialType),t.onlyvis||(r.physic=new WHS.API.ConvexFigure(r.visible.geometry),r.body=new CANNON.Body({mass:a.mass}),r.body.linearDamping=.9,r.body.addShape(r.physic));break;case"plane":api.def(a.geometry.func,function(){}),api.def(a.geometry.width,10),api.def(a.geometry.height,10),api.def(a.geometry.segments,32),r.visible=new THREE.Mesh(new THREE.PlaneBufferGeometry(a.geometry.width,a.geometry.height,a.geometry.segments),r.materialType),t.onlyvis||(r.physic=new WHS.API.ConvexFigure(r.visible.geometry),r.body=new CANNON.Body({mass:a.mass}),r.body.linearDamping=.9,r.body.addShape(r.physic));break;case"polyhedron":api.def(a.geometry.verticesOfCube,[]),api.def(a.geometry.indicesOfFaces,[]),api.def(a.geometry.radius,1),api.def(a.geometry.detail,1),r.visible=new THREE.Mesh(new THREE.PolyhedronGeometry(a.geometry.verticesOfCube,a.geometry.indicesOfFaces),r.materialType),t.onlyvis||(r.physic=new WHS.API.ConvexFigure(r.visible.geometry),r.body=new CANNON.Body({mass:a.mass}),r.body.linearDamping=.9,r.body.addShape(r.physic));break;case"ring":api.def(a.geometry.innerRadius,0),api.def(a.geometry.outerRadius,50),api.def(a.geometry.thetaSegments,1),api.def(a.geometry.phiSegments,8),api.def(a.geometry.thetaStart,0),api.def(a.geometry.thetaLength,2*Math.PI),r.visible=new THREE.Mesh(new THREE.TorusGeometry(a.geometry.outerRadius,(a.geometry.outerRadius-a.geometry.innerRadius)/2,a.geometry.thetaSegments,a.geometry.phiSegments),r.materialType),r._scale.z=4/(a.geometry.outerRadius-a.geometry.innerRadius),t.onlyvis||(r.physic=CANNON.Trimesh.createTorus(a.geometry.outerRadius,(a.geometry.outerRadius-a.geometry.innerRadius)/2,a.geometry.thetaSegments,a.geometry.phiSegments),r.body=new CANNON.Body({mass:a.mass}),r.body.linearDamping=.9,r.body.addShape(r.physic));break;case"shape":r.visible=new THREE.Mesh(new THREE.ShapeGeometry(a.geometry.shapes),r.materialType),r.onlyvis=!0,console.warn("This is not physic object. 2D!",[r]);break;case"tetrahedron":api.def(a.geometry.radius,1),api.def(a.geometry.detail,0),r.visible=new THREE.Mesh(new THREE.TetrahedronGeometry(a.geometry.radius,a.geometry.detail),r.materialType),t.onlyvis||(r.physic=new WHS.API.ConvexFigure(this.visible.geometry),r.body=new CANNON.Body({mass:a.mass}),r.body.linearDamping=.9,r.body.addShape(r.physic));break;case"text":a.geometry.parameters=a.geometry.parameters||{},api.def(a.geometry.text,"Hello World!"),api.def(a.geometry.parameters.size,1),api.def(a.geometry.parameters.height,50),api.def(a.geometry.parameters.curveSegments,1),api.def(a.geometry.parameters.font,"Adelle"),api.def(a.geometry.parameters.weight,"normal"),api.def(a.geometry.parameters.style,"normal"),api.def(a.geometry.parameters.bevelEnabled,!1),api.def(a.geometry.parameters.bevelThickness,10),api.def(a.geometry.parameters.bevelSize,8),r.visible=new THREE.Mesh(new THREE.TextGeometry(a.geometry.text,a.geometry.parameters),r.materialType),t.onlyvis||(r.physic=new WHS.API.TrimeshFigure(r.visible.geometry),r.body=new CANNON.Body({mass:a.mass}),r.body.linearDamping=.9,r.body.addShape(r.physic));break;case"torus":api.def(a.geometry.radius,100),api.def(a.geometry.tube,40),api.def(a.geometry.radialSegments,8),api.def(a.geometry.tubularSegments,6),api.def(a.geometry.arc,2*Math.PI),r.visible=new THREE.Mesh(new THREE.TorusGeometry(a.geometry.radius,a.geometry.tube,a.geometry.radialSegments,a.geometry.tubularSegments,a.geometry.arc),r.materialType),t.onlyvis||(r.physic=CANNON.Trimesh.createTorus(a.geometry.radius,a.geometry.tube,a.geometry.radialSegments,a.geometry.tubularSegments),r.body=new CANNON.Body({mass:a.mass}),r.body.linearDamping=.9,r.body.addShape(r.physic));break;case"torusknot":api.def(a.geometry.radius,100),api.def(a.geometry.tube,40),api.def(a.geometry.radialSegments,8),api.def(a.geometry.tubularSegments,6),api.def(a.geometry.arc,2*Math.PI),r.visible=new THREE.Mesh(new THREE.TorusKnotGeometry(a.geometry.radius,a.geometry.tube,a.geometry.radialSegments,a.geometry.tubularSegments,a.geometry.p,a.geometry.q,a.geometry.heightScale),r.materialType),t.onlyvis||(r.physic=new WHS.API.TrimeshFigure(r.visible.geometry),r.body=new CANNON.Body({mass:a.mass}),r.body.linearDamping=.9,r.body.addShape(r.physic));break;case"tube":r.CustomSinCurve=THREE.Curve.create(function(e){this.scale=e||1},function(e){var t=3*e-1.5,r=Math.sin(2*Math.PI*e),a=0;return new THREE.Vector3(t,r,a).multiplyScalar(this.scale)}),a.geometry.path||(a.geometry.path=new this.CustomSinCurve(100)),api.def(a.geometry.segments,20),api.def(a.geometry.radius,2),api.def(a.geometry.radiusSegments,8),api.def(a.geometry.closed,!1),r.visible=new THREE.Mesh(new THREE.TubeGeometry(a.geometry.path,a.geometry.segments,a.geometry.radius,a.geometry.radiusSegments,a.geometry.closed),r.materialType),t.onlyvis||(r.physic=new WHS.API.TrimeshFigure(r.visible.geometry),r.body=new CANNON.Body({mass:a.mass}),r.body.linearDamping=.9,r.body.addShape(r.physic))}return r.addCompoundFace=function(){this.compoundFace=new THREE.Geometry,this.compoundFace.faces.push(new THREE.Face3(0,1,2));var e=(new THREE.Box3).setFromObject(this.visible),t=new THREE.BoxGeometry(e.max.x-e.min.x,e.max.y-e.min.y,e.max.z-e.min.z),r=t.vertices[t.faces[7].a].add(this.visible.position),a=t.vertices[t.faces[7].b].add(this.visible.position),o=t.vertices[t.faces[7].c].add(this.visible.position);this.compoundFace.vertices.push(r),this.compoundFace.vertices.push(a),this.compoundFace.vertices.push(o)},r.remove=function(){return r.wrap.remove()},r.retrieve=function(){return r.wrap.retrieve()},r.build(r.visible,r.body),r.wrap=new api.Wrap(r,r.visible,r.body),r},WHS.init.prototype.addGrass=function(e,t){"use strict";var r={};r.root=this,r.opts=t,r.onlyvis=!0,r.opts.coords||console.warn("Please add grass objects coordinates! @addGrass"),r.grassMeshes=[];var a=new THREE.Mesh(new THREE.Geometry,new THREE.MeshFaceMaterial);return r.opts.coords.forEach(function(t){var o=new THREE.Mesh(new THREE.Geometry,new THREE.MeshBasicMaterial({map:THREE.ImageUtils.loadTexture("assets/textures/thingrass.png"),side:THREE.DoubleSide,blending:THREE.NormalBlending,transparent:!0,alphaTest:.5})),i=WHS.API.getheight({x:t.x,y:t.y},500,e,-1)[0],n=i.object.geometry.vertices,s=new THREE.Geometry;s.faces.push(new THREE.Face3(0,1,2)),s.vertices.push(n[i.face.a]),s.vertices.push(n[i.face.c]),s.vertices.push(n[i.face.b]),s.computeFaceNormals(),o.position.set(0,0,0),o.geometry.vertices.push(n[i.face.a].clone()),o.geometry.vertices.push(n[i.face.c].clone()),o.geometry.vertices.push(n[i.face.a].clone().add(s.faces[0].normal)),o.geometry.vertices.push(n[i.face.c].clone().add(s.faces[0].normal));var c=new THREE.Vector3(n[i.face.a].clone().x/2+n[i.face.c].clone().x/2,n[i.face.a].clone().y/2+n[i.face.c].clone().y/2,n[i.face.a].clone().z/2+n[i.face.c].clone().z/2);o.geometry.vertices.push(c.clone().add(c.clone().sub(n[i.face.b].clone()))),o.geometry.vertices.push(n[i.face.b].clone()),o.geometry.vertices.push(n[i.face.b].clone().add(s.faces[0].normal)),o.geometry.vertices.push(c.clone().add(c.clone().sub(n[i.face.b].clone())).add(s.faces[0].normal)),o.geometry.faces.push(new THREE.Face3(0,1,2)),o.geometry.faces.push(new THREE.Face3(1,2,3)),o.geometry.faces.push(new THREE.Face3(4,6,5)),o.geometry.faces.push(new THREE.Face3(4,6,7)),o.geometry.faceVertexUvs[0].push([new THREE.Vector2(0,0),new THREE.Vector2(1,0),new THREE.Vector2(0,1)]),o.geometry.faceVertexUvs[0].push([new THREE.Vector2(0,0),new THREE.Vector2(1,1),new THREE.Vector2(0,1)]),o.geometry.faceVertexUvs[0].push([new THREE.Vector2(0,0),new THREE.Vector2(1,1),new THREE.Vector2(1,0)]),o.geometry.faceVertexUvs[0].push([new THREE.Vector2(0,0),new THREE.Vector2(1,1),new THREE.Vector2(0,1)]),o.geometry.uvsNeedUpdate=!0,a.geometry.merge(o.geometry,o.matrix),a.material.materials.push(o.material),r.grassMeshes.push(o)}),r.wrap=api.Wrap(r,a),r.update=function(){},r.update(),r},WHS.init.prototype.addGround=function(e,t,r,a){"use strict";var o={pos:a},i=new api.construct(this,o,e);switch(i.skip=!0,api.def(t,{width:100,height:100}),i.materialType=api.loadMaterial(r)._material,e){case"smooth":i.visible=new THREE.Mesh(new THREE.PlaneBufferGeometry(t.width,t.height,1,1),i.materialType),i._rot.set(-0.5*Math.PI,0,0),i.physic=new CANNON.Plane(t.width,t.height),i.body=new CANNON.Body({mass:0}),i.body.linearDamping=.9,i.body.addShape(i.physic),i.body.quaternion.setFromAxisAngle(new CANNON.Vec3(1,0,0),-Math.PI/2);break;case"infinitySmooth":i.visible=new THREE.Mesh(new THREE.PlaneBufferGeometry(t.width,t.height,1,1),i.materialType),i._rot.set(-0.5*Math.PI,0,0),i.physic=new CANNON.Plane(t.width,t.height),i.body=new CANNON.Body({mass:0}),i.body.linearDamping=.9,i.body.addShape(i.physic),i.body.position.set(posscopex,a.y,a.z),i.body.quaternion.setFromAxisAngle(new CANNON.Vec3(1,0,0),-Math.PI/2);break;case"terrain":var n=document.createElement("canvas");if(n.setAttribute("width",t.width),n.setAttribute("height",t.height),n.getContext){var s=n.getContext("2d");s.drawImage(t.terrain,0,0)}var c=api.TextureLoader().load(i.root._settings.assets+"/textures/terrain/dirt-512.jpg");c.wrapS=c.wrapT=THREE.RepeatWrapping;var l=api.TextureLoader().load(i.root._settings.assets+"/textures/terrain/sand-512.jpg");l.wrapS=l.wrapT=THREE.RepeatWrapping;var m=api.TextureLoader().load(i.root._settings.assets+"/textures/terrain/grass-512.jpg");m.wrapS=m.wrapT=THREE.RepeatWrapping;var d=api.TextureLoader().load(i.root._settings.assets+"/textures/terrain/rock-512.jpg");d.wrapS=d.wrapT=THREE.RepeatWrapping;var p=api.TextureLoader().load(i.root._settings.assets+"/textures/terrain/snow-512.jpg");p.wrapS=p.wrapT=THREE.RepeatWrapping;var h=(THREE.NormalMapShader,256),u=256,f={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat},y=new THREE.WebGLRenderTarget(h,u,f);y.texture=api.TextureLoader().load("../assets/terrain/default_terrain.png");var E=new THREE.WebGLRenderTarget(h,u,f);E.texture=api.TextureLoader().load("../assets/terrain/NormalMap.png");var g=new THREE.WebGLRenderTarget(256,256,f);g.texture=api.TextureLoader().load("../assets/terrain/default_terrain.png");var v=THREE.ShaderTerrain.terrain,w=Object.assign(THREE.UniformsUtils.clone(v.uniforms),{oceanTexture:{type:"t",value:c},sandyTexture:{type:"t",value:l},grassTexture:{type:"t",value:m},rockyTexture:{type:"t",value:d},snowyTexture:{type:"t",value:p},fog:!0,lights:!0},THREE.UniformsLib.common,THREE.UniformsLib.fog,THREE.UniformsLib.lights,THREE.UniformsLib.shadowmap,{ambient:{type:"c",value:new THREE.Color(16777215)},emissive:{type:"c",value:new THREE.Color(0)},wrapRGB:{type:"v3",value:new THREE.Vector3(1,1,1)}});w.tDisplacement.value=y,w.shadowMap.value=[E],w.uDisplacementScale.value=100,w.uRepeatOverlay.value.set(6,6);var r=new THREE.ShaderMaterial({uniforms:w,vertexShader:v.vertexShader,fragmentShader:v.fragmentShader,lights:!0,fog:!0,side:THREE.DoubleSide,shading:THREE.SmoothShading}),b=new THREE.PlaneGeometry(256,256,255,255);b.verticesNeedUpdate=!0,i.visible=new THREE.Mesh(b,r),i._rot.set(Math.PI/180*-90,0,0);for(var T=[],H=0,R=0,S=s.getImageData(0,0,256,256).data,x=0;255>=x;x++){T[x]=new Uint8Array(256);for(var N=255;N>=0;N--)T[x][255-N]=s.getImageData(x,N,1,1).data[0]/255*100,b.vertices[H].z=S[R]/255*100,R+=4,H++}b.computeVertexNormals(),b.computeFaceNormals(),i.visible.updateMatrix(),i.physic=new CANNON.Heightfield(T,{elementSize:1}),i.body=new CANNON.Body({mass:0}),i.body.linearDamping=.9,i.body.addShape(i.physic),i.body.quaternion.setFromEuler(Math.PI/180*-90,0,0,"XYZ"),i.body.position.set(a.x-t.width/2+.5,a.y,a.z+t.height/2-.5),i.dtb=!0,i.body.name=i.name,i.visible.castShadow=!0,i.visible.receiveShadow=!0}return i.build(i.visible,i.body),i.wrap=api.Wrap(i,i.visible,i.body),i},WHS.init.prototype.addFog=function(e,t){"use strict";var r={};switch(api.def(t.hex,0),api.def(t.near,.015),api.def(t.far,1e3),api.def(t.density,25e-5),e){case"fog":r=new THREE.Fog(t.hex,t.near,t.far);break;case"fogexp2":r=new THREE.FogExp2(t.hex,t.density)}return r},WHS.init.prototype.addLight=function(e,t,r,a){var o=new api.construct(this,{pos:r},e);o.skip=!0;var i=api.def(t,{});switch(api.def(t.color,16777215,i.color),api.def(t.skyColor,16777215,i.skyColor),api.def(t.groundColor,16777215,i.groundColor),api.def(t.intensity,1,i.intensity),api.def(t.distance,100,i.distance),api.def(t.angle,Math.PI/3,i.angle),e){case"ambient":o.visible=new THREE.AmbientLight(16777215);break;case"area":o.visible=new THREE.AreaLight(i.color,i.intensity),console.warn([this.visible],"This light only works in the deferredrenderer");break;case"directional":o.visible=new THREE.DirectionalLight(i.color,i.intensity);break;case"hemisphere":o.visible=new THREE.HemisphereLight(i.skyColor,i.groundColor,i.intensity);break;case"light":o.visible=new THREE.Light(i.color);break;case"point":o.visible=new THREE.PointLight(i.color,i.intensity,i.distance);break;case"spot":o.visible=new THREE.SpotLight(i.color,i.intensity,i.distance,i.angle)}o.visible.castShadow=!0,o.visible.shadowMapWidth=1024,o.visible.shadowMapHeight=1024,o.visible.shadowBias=1e-4,o.visible.shadowCameraNear=!0,o.visible.shadowCameraFar=400,o.visible.shadowCameraFov=60,o.visible.shadowDarkness=.3;var n=200;return o.visible.shadowCameraLeft=-n,o.visible.shadowCameraRight=n,o.visible.shadowCameraTop=n,o.visible.shadowCameraBottom=-n,o.visible.target&&o.visible.target.position.set(o._target.x,o._target.y,o._target.z),o.build(),o.wrap=api.Wrap(o,o.visible),o},WHS.init.prototype.addWagner=function(e,t,r){"use strict";r=r||{};var a={};switch(t){case"zoomBlurPass":a.effect=new e.ZoomBlurPass,a.effect.params.strength=.05,a.effect.params.center.set(.5*this._composer.width,.5*this._composer.height),this._composer.pass(a.effect);break;case"multiPassBloomPass":a.effect=new e.MultiPassBloomPass,a.effect.params.blurAmount=1.32,a.effect.params.strength=.5,a.effect.params.applyZoomBlur=!0,a.effect.params.zoomBlurStrength=.84,a.effect.params.useTexture=!0,a.effect.glowTexture=e.Pass.prototype.getOfflineTexture(this._composer.width,this._composer.height,!1),a.effect.params.center.set(.5*this._composer.width,.5*this._composer.height),this._composer.pass(a.effect);break;case"vignettePass":a.effect=new e.VignettePass,a.effect.params.amount=.7,a.effect.params.falloff=.2,this._composer.pass(a.effect);break;case"directionalBlurPass":a.effect=new e.DirectionalBlurPass,a.effect.params.delta=.1,this._composer.pass(a.effect);break;case"motionBlurPass":a.motionBlurEffect=new e.DirectionalBlurPass,a.motionBlurEnable=!0,a.motionBlurEffect.params.delta=0,a.effect=a.motionBlurEffect,this._composer.pass(a.effect);break;case"ASCIIPass":a.effect=new e.ASCIIPass,this._composer.pass(a.effect);break;case"dotScreenPass":a.effect=new e.DotScreenPass,this._composer.pass(a.effect);break;case"fxaaPass":a.effect=new e.FXAAPass,this._composer.pass(a.effect);break;case"chromaticAberrationPass":a.effect=new e.ChromaticAberrationPass,this._composer.pass(a.effect);break;case"dirtPass":a.effect=new e.DirtPass,this._composer.pass(a.effect);break;case"edgeDetectionPass":a.effect=new e.SobelEdgeDetectionPass,this._composer.pass(a.effect);break;case"highPassPass":a.effect=new e.HighPassPass,this._composer.pass(a.effect);break;case"grayscalePass":a.effect=new e.GrayscalePass,this._composer.pass(a.effect);break;case"halftonePass":a.effect=new e.HalftonePass,this._composer.pass(a.effect);break;case"invertPass":a.effect=new e.InvertPass,this._composer.pass(a.effect);break;default:return void console.warn('No Wagner effect "'+t+'" exists. If it should exist, open an issue. (@addWagner)')}return this._composer.toScreen(),a._composer=this._composer,a.apply=function(){return this._composer.eff.push(a.effect),a},a},WHS.init.prototype.MakeFirstPerson=function(e,t,r){"use strict";this.controls=new t(this._camera,e.body,10,this);var a=this.controls;WHS.API.merge(this.scene,this.controls.getObject()),this._dom.append('<div id="blocker">   <center>      <h1>PointerLock</h1>   </center>   <br>   <p>(W,A,S,D = Move, SPACE = Jump, MOUSE = Look)</p></div>');var o=$(r);if(o.css({color:"white",background:"rgba(0,0,0,0.5)","text-align":"center",position:"absolute",width:"100%",height:"100%",left:0,top:0}),"pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document){var i=document.body;this.pointerlockchange=function(){document.pointerLockElement===i||document.mozPointerLockElement===i||document.webkitPointerLockElement===i?(a.enabled=!0,o.css({display:"none"})):(a.enabled=!1,o.css({display:"block"}))}}document.addEventListener("pointerlockchange",this.pointerlockchange,!1),document.addEventListener("mozpointerlockchange",this.pointerlockchange,!1),document.addEventListener("webkitpointerlockchange",this.pointerlockchange,!1),this.pointerlockerror=function(){console.warn("Pointer lock error.")},document.addEventListener("pointerlockerror",this.pointerlockerror,!1),document.addEventListener("mozpointerlockerror",this.pointerlockerror,!1),document.addEventListener("webkitpointerlockerror",this.pointerlockerror,!1),o.on("click",function(){if(i.requestPointerLock=i.requestPointerLock||i.mozRequestPointerLock||i.webkitRequestPointerLock,/Firefox/i.test(navigator.userAgent)){var e=function(){(document.fullscreenElement===i||document.mozFullscreenElement===i||document.mozFullScreenElement===i)&&(document.removeEventListener("fullscreenchange",e),document.removeEventListener("mozfullscreenchange",e),i.requestPointerLock())};document.addEventListener("fullscreenchange",e,!1),document.addEventListener("mozfullscreenchange",e,!1),i.requestFullscreen=i.requestFullscreen||i.mozRequestFullscreen||i.mozRequestFullScreen||i.webkitRequestFullscreen,i.requestFullscreen()}else i.requestPointerLock()})},WHS.init.prototype.OrbitControls=function(e){this.controls=new THREE.OrbitControls(this._camera,this.renderer.domElement)},WHS.init.prototype.addSkybox=function(e,t){"use strict";t=t||".png";var r=new THREE.AxisHelper(100),a=this.scene;a.add(r);for(var o=e,i=["xpos","xneg","ypos","yneg","zpos","zneg"],n=new THREE.CubeGeometry(5e3,5e3,5e3),s=[],c=0;6>c;c++)s.push(new THREE.MeshBasicMaterial({map:THREE.ImageUtils.loadTexture(o+i[c]+t),side:THREE.BackSide}));var l=new THREE.MeshFaceMaterial(s),m=new THREE.Mesh(n,l);a.add(m)};